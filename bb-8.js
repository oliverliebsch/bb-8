// Generated by CoffeeScript 1.10.0
(function() {
  var BB8, Controls, Heading, SingleImage, Subheading, blockMixin, eventHub, vm;

  eventHub = new Vue();

  Controls = {
    template: '#template-controls',
    props: ['index'],
    methods: {
      addBlock: function(type) {
        return eventHub.$emit('bb8-add-block', {
          blocktype: type,
          index: this.index
        });
      }
    }
  };

  blockMixin = {
    data: function() {
      return {
        block: this.initialData
      };
    },
    props: ['blocks', 'initialData', 'index'],
    components: {
      'controls': Controls
    },
    created: function() {
      debugger;
    },
    methods: {
      updateText: function(text) {
        this.block.text = text;
        return this.$emit('bb8-update-block', this.block);
      }
    }
  };

  Heading = {
    template: '#template-heading',
    mixins: [blockMixin]
  };

  Subheading = {
    template: '#template-subheading',
    mixins: [blockMixin]
  };

  SingleImage = {
    template: '#template-single-image',
    mixins: [blockMixin],
    methods: {
      updateImage: function(event) {
        var file, reader, thus;
        file = event.target.files[0];
        thus = this;
        reader = new FileReader();
        reader.onloadend = function(e) {
          if (e.target.readyState === FileReader.DONE) {
            return thus.block.image = e.target.result;
          }
        };
        reader.readAsDataURL(file);
        return this.$emit('bb8-update-block', this.block);
      }
    }
  };

  BB8 = {
    template: '#template-bb8',
    data: function() {
      return {
        blocks: [],
        ids: [],
        output: ''
      };
    },
    props: ['initialJson'],
    components: {
      'controls': Controls,
      'heading': Heading,
      'subheading': Subheading,
      'single-image': SingleImage
    },
    computed: {
      ids: function() {
        return _.map(this.blocks, 'id').sort();
      }
    },
    created: function() {
      this.blocks = JSON.parse(this.initialJson);
      eventHub.$on('bb8-add-block', this.addBlock);
      return eventHub.$on('bb8-form-submitted', this.compileBlocks);
    },
    methods: {
      addBlock: function(newBlock) {
        var fields;
        switch (newBlock.blocktype) {
          case 'heading':
          case 'subheading':
            fields = {
              text: ''
            };
            break;
          case 'single-image':
            fields = {
              image: '',
              text: ''
            };
        }
        return this.blocks.splice(newBlock.index + 1, 0, _.merge({
          blocktype: newBlock.blocktype,
          id: this.ids.length ? _.last(this.ids) + 1 : 1
        }, fields));
      },
      compileBlocks: function() {
        return this.output = JSON.stringify(this.blocks);
      }
    }
  };

  vm = new Vue({
    el: '#bb8-form',
    components: {
      'bb8': BB8
    },
    methods: {
      submit: function(event) {
        event.preventDefault();
        return eventHub.$emit('bb8-form-submitted');
      }
    }
  });

}).call(this);
