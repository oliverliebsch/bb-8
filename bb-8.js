// Generated by CoffeeScript 1.10.0
(function() {
  var BB8, Controls, Heading, SingleImage, Subheading, blockMixin, eventBus, vm;

  eventBus = new Vue();

  Controls = {
    template: '#template-controls',
    props: ['index'],
    methods: {
      addBlock: function(type) {
        return eventBus.$emit('bb8-add-block', {
          blocktype: type,
          index: this.index
        });
      }
    }
  };

  blockMixin = {
    data: function() {
      return {
        block: this.initialData
      };
    },
    props: ['initialData', 'index'],
    components: {
      'controls': Controls
    },
    created: function() {
      return _.defaults(this.initialData, {
        fields: this.fields
      });
    },
    methods: {
      updateText: function(text) {
        return this.block.fields[0].content = text;
      }
    }
  };

  Heading = {
    template: '#template-heading',
    mixins: [blockMixin],
    data: function() {
      return {
        fields: [
          {
            type: 'text',
            content: ''
          }
        ]
      };
    }
  };

  Subheading = {
    template: '#template-subheading',
    mixins: [blockMixin],
    data: function() {
      return {
        fields: [
          {
            type: 'text',
            content: ''
          }
        ]
      };
    }
  };

  SingleImage = {
    template: '#template-single-image',
    mixins: [blockMixin],
    data: function() {
      return {
        fields: [
          {
            type: 'text',
            content: ''
          }, {
            type: 'image',
            content: ''
          }
        ]
      };
    },
    methods: {
      updateImage: function(event) {
        var file, reader, that;
        file = event.target.files[0];
        that = this;
        reader = new FileReader();
        reader.onloadend = function(e) {
          if (e.target.readyState === FileReader.DONE) {
            return that.block.fields[1].content = e.target.result;
          }
        };
        return reader.readAsDataURL(file);
      }
    }
  };

  BB8 = {
    template: '#template-bb8',
    data: function() {
      return {
        blocks: [],
        ids: [],
        output: ''
      };
    },
    props: ['initialJson'],
    components: {
      'controls': Controls,
      'heading': Heading,
      'subheading': Subheading,
      'single-image': SingleImage
    },
    computed: {
      ids: function() {
        return _.map(this.blocks, 'id').sort();
      }
    },
    created: function() {
      var block, blocks, i, len;
      blocks = JSON.parse(this.initialJson);
      for (i = 0, len = blocks.length; i < len; i++) {
        block = blocks[i];
        block.id = blocks.indexOf(block) + 1;
      }
      this.blocks = blocks;
      this.compileBlocks();
      eventBus.$on('bb8-add-block', this.addBlock);
      return eventBus.$on('bb8-form-submitted', this.compileBlocks);
    },
    methods: {
      createBlockId: function() {
        if (this.ids.length) {
          return _.last(this.ids) + 1;
        } else {
          return 1;
        }
      },
      addBlock: function(newBlock) {
        return this.blocks.splice(newBlock.index + 1, 0, {
          blocktype: newBlock.blocktype,
          id: this.createBlockId()
        });
      },
      compileBlocks: function() {
        return this.output = JSON.stringify(this.blocks);
      }
    }
  };

  vm = new Vue({
    el: '#bb8-form',
    components: {
      'bb8': BB8
    },
    methods: {
      submit: function(event) {
        event.preventDefault();
        return eventBus.$emit('bb8-form-submitted');
      }
    }
  });

}).call(this);
